version: '3'

# Load environment variables from .env file
dotenv: ['.env']

vars:
  BINARY_NAME: gin-sample

tasks:
  # Development
  dev:
    desc: Start dev environment (dependencies + hot reload)
    deps: [docker:up]
    cmd: air

  run:
    desc: Run the server
    cmd: go run cmd/server/main.go

  build:
    desc: Build the binary
    cmd: go build -o {{.BINARY_NAME}} cmd/server/main.go

  test:
    desc: Run unit tests
    cmd: go test -v -short ./...

  test:unit:
    desc: Run unit tests with coverage
    cmd: go test -v -short -coverprofile=coverage.out -covermode=atomic ./...

  test:integration:
    desc: Run integration tests (requires Docker)
    cmd: go test -v -tags=integration ./test/integration/...

  test:all:
    desc: Run all tests (unit + integration)
    cmd: go test -v -tags=integration -coverprofile=coverage.out -covermode=atomic ./...

  test:coverage:
    desc: View test coverage in browser
    deps: [test:unit]
    cmd: go tool cover -html=coverage.out

  test:report:
    desc: Show coverage summary
    deps: [test:unit]
    cmd: go tool cover -func=coverage.out

  mocks:
    desc: Generate all mocks
    cmd: go generate ./...

  sync:
    desc: Sync dependencies
    cmd: go mod tidy

  seed:
    desc: Seed database with test data
    deps: [docker:up]
    cmd: go run cmd/seed/main.go

  index:
    desc: Create MongoDB indexes
    deps: [docker:up]
    cmd: go run cmd/index/main.go

  # Docker
  docker:up:
    desc: Start dependencies (MongoDB, Redis, MinIO)
    cmd: docker compose up -d

  docker:prod:
    desc: Start full stack including app (production-like)
    cmd: docker compose --profile prod up -d --build

  docker:down:
    desc: Stop Docker services
    cmd: docker compose --profile prod down

  docker:logs:
    desc: View Docker logs
    cmd: docker compose logs -f

  # Setup
  setup:
    desc: Install git hooks (run once after clone)
    cmd: lefthook install

  # Utilities
  lint:
    desc: Run linter (requires golangci-lint)
    cmd: golangci-lint run

  fmt:
    desc: Format code
    cmd: go fmt ./...

  swagger:
    desc: Generate swagger docs
    cmd: swag init -g cmd/server/main.go -o swagger
