name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Optional: Only run on specific file changes
    # paths:
    #   - "src/**/*.ts"
    #   - "src/**/*.tsx"
    #   - "src/**/*.js"
    #   - "src/**/*.jsx"

jobs:
  claude-review:
    # Optional: Filter by PR author
    # if: |
    #   github.event.pull_request.user.login == 'external-contributor' ||
    #   github.event.pull_request.user.login == 'new-developer' ||
    #   github.event.pull_request.author_association == 'FIRST_TIME_CONTRIBUTOR'

    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          use_sticky_comment: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            ## Code Review Guidelines (Based on Google Engineering Practices)

            ### Core Principle
            Approve the PR if it **improves overall code health**, even if it isn't perfect.
            Seek continuous improvement, not perfection. Don't block PRs for minor issues.

            ### What to Review
            Evaluate the following areas:
            - **Design**: Is the architecture sound? Does it fit the system?
            - **Functionality**: Does it work correctly? Edge cases handled?
            - **Complexity**: Can it be understood quickly? Is it over-engineered?
            - **Tests**: Are there appropriate tests? Will they catch regressions?
            - **Naming**: Are names clear and descriptive?
            - **Comments**: Do comments explain *why*, not *what*?
            - **Style**: Does it follow CLAUDE.md conventions?
            - **Documentation**: Are docs updated for user-facing changes?

            ### Comment Guidelines
            - Focus on the **code**, not the author
            - Explain your reasoning - help the author learn
            - Label comments by severity:
              - `Blocking:` Must be fixed before approval
              - `Suggestion:` Recommended improvement
              - `Nit:` Minor polish, optional to address
            - **Acknowledge good practices** - mention what's done well

            ### Decision Criteria
            - **Approve**: Code improves health, issues are minor (Nit/Suggestion level)
            - **Request Changes**: Has blocking issues (bugs, security, design flaws)

            ### Output Format
            Structure your review as:
            1. **Summary**: One-line assessment
            2. **Strengths**: What's done well (be specific)
            3. **Feedback**: Issues found with severity labels
            4. **Verdict**: Approve or Request Changes with reasoning

            Use the repository's CLAUDE.md for project-specific style and conventions.

            Use `gh pr comment` with your Bash tool to leave your review as a comment on the PR.

          # Use Claude Opus 4.5 model with allowed tools for PR review
          claude_args: '--model claude-opus-4-5 --allowed-tools "Bash(gh issue view:*),Bash(gh search:*),Bash(gh issue list:*),Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*)"'

